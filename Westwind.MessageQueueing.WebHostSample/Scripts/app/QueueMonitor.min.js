var Page=function(){var n=this;return $.extend(this,{hub:null,hubUrl:"http://localhost:8080/signalr",initialQueue:"",token:null,viewModel:{status:{queueName:"",threadCount:0,waitInterval:0,paused:!1,serviceStatus:"Running"},queueItem:{id:"",date:new Date,status:"",message:"",xml:""},queueNames:ko.observableArray([]),connectionStatus:ko.observable("Not connected."),waitingMessages:ko.observable(0),queueMessages:ko.observableArray([]),activeQueue:ko.observable("")},initialize:function(){showStatus({autoClose:!0,closable:!0});toastr.timeOut=4e3;n.viewModel.status=ko.mapping.fromJS(n.viewModel.status);n.viewModel.queueItem=ko.mapping.fromJS(n.viewModel.queueItem);n.viewModel.activeQueue(page.initialQueue);$("#ItemDetail").makeAbsolute().css("z-index","1000").closable({cssClass:"closebox-container"}).draggable({handle:".dialog-header"});$("#btnReconnect").click(function(){n.hub==null?toastr.error("Unable to connect. Please refresh the page."):$.connection.hub.start()});$(document.body).on("click",".message-item",n.getQueueMessage);$("#btnUpdateStatus").click(n.btnUpdateStatus);$("#btnRefresh").click(n.btnRefresh);$(document).on("click","#btnStopService",n.stopService);$(document).on("click","#btnStartService",n.startService);setInterval(n.getWaitingQueueMessageCount,3e3);ko.applyBindings(n.viewModel);$(document).on("change","#lstQueues",function(){n.getServiceStatus()})},startHub:function(){$.connection.hub.url=n.hubUrl;$.connection.hub.qs={token:page.token};n.hub=$.connection.queueMonitorServiceHub;var t=n.hub;if(t==null){n.viewModel.connectionStatus("Offline");toastr.error("Couldn't connect to server. Please refresh the page.");return}t.connection.error(function(t){t&&toastr.error("An error occurred: "+t.message);n.hub=null});t.connection.disconnected(function(t){n.viewModel.connectionStatus("Connection lost");toastr.error("Connection lost. "+t);setTimeout(function(){$.connection.hub.start()},2e3)});t.client.writeMessage=n.writeMessage;t.client.writeQueueMessage=n.writeQueueMessage;t.client.statusMessage=n.statusMessage;t.client.getServiceStatusCallback=n.getServiceStatusCallback;t.client.updateServiceStatusCallback=n.updateServiceStatusCallback;t.client.getWaitingQueueMessageCountCallback=n.getWaitingQueueMessageCountCallback;t.client.stopServiceCallback=n.stopServiceCallback;t.client.startServiceCallback=n.startServiceCallback;t.client.getQueueMessageCallback=n.getQueueMessageCallback;t.client.getQueueNamesCallback=n.getQueueNamesCallback;$.connection.hub.start().done(function(){t.connection.stateChanged(function(t){t.newState===$.signalR.connectionState.reconnecting?n.viewModel.connectionStatus("Connection lost"):t.newState===$.signalR.connectionState.connected?(n.viewModel.connectionStatus("Online"),n.hub=$.connection.queueMonitorServiceHub):t.newState===$.signalR.connectionState.disconnected&&n.viewModel.connectionStatus("Disconnected")}).error(function(n){n||(n="Disconnected");toastr.error(n.message)}).disconnected(function(n){toastr.warning("Disconnected: "+n)});n.viewModel.connectionStatus("Online");n.viewModel.activeQueue(n.initialQueue);n.getQueueNames();n.getInitialMessages();setTimeout(n.getServiceStatus,200)})},messageCounter:0,writeMessage:function(t,i,r,u,f,e,o){var l=$("<div>").addClass("message-item"),p,c,a,v,w;if(n.messageCounter++,n.messageCounter%2==0&&l.addClass("alternate"),!n.viewModel.activeQueue()||!o||o==n.viewModel.activeQueue()){u?l.data("id",u):(u=t,t=null);r||(r=(new Date).formatDate("HH:mm:ss`"));var y=$("<table>").addClass("message-table"),h=$("<tr>"),s=$("<td>").addClass("message-status").text(i);if(s.appendTo(h),p="",p=i=="Completed"||i=="Ok"||i=="Success"?"icon-ok":i=="Started"?"icon-running":i=="Cancelled"||i=="Failed"||i=="Error"?"icon-error":"icon-info",s.prepend("<span class='"+p+"'><\/span>"),s=$("<td>").addClass("message-time").text(r),s.appendTo(h),s=$("<td>").text(u),s.appendTo(h),c="",o&&(c+="<b>"+o+"<\/b> | "),f&&(c?c+=f:c=f),s=$("<td>").addClass("message-elapsed").html(c),h.append(s),h.appendTo(y),t&&(h=$("<tr>"),s=$("<td>").attr("colspan","1"),s.appendTo(h),t="<pre style='font-size: 8pt;padding: 3px 5px;margin: 0'>"+t.trim()+"<\/pre>",s=$("<td>").attr("colspan","3").css("text-overflow","clip"),t.indexOf("/>")>0||t.indexOf("<\/")>0?s.html(t):s.text(t),s.appendTo(h),h.appendTo(y)),y.appendTo(l),l.prependTo("#MessageContent"),a=$("#MessageContent>div"),a.length>25)for(v=20;v<a.length;v++)w=a[v],w!=null&&$(w).remove();typeof e=="number"&&e>-1&&n.viewModel.waitingMessages(e)}},statusMessage:function(n){toastr.info(n)},getInitialMessages:function(){n.hub.server.getInitialMessages(n.initialQueue).fail(toastr.error)},getServiceStatus:function(){n.hub.server.getServiceStatus(n.viewModel.activeQueue()).fail(toastr.error)},getServiceStatusCallback:function(t){var i=n.viewModel;t||(t={queueName:"",threadCount:"",waitInterval:""});ko.mapping.fromJS(t,i.status)},stopService:function(){n.hub.server.stopService()},stopServiceCallback:function(){n.viewModel.status.paused(!0)},startService:function(){n.hub.server.startService()},startServiceCallback:function(){n.viewModel.status.paused(!1)},updateServiceStatusCallback:function(t){var i=n.viewModel;n.getServiceStatusCallback(t)},getQueueMessage:function(){var t=$(this).data("id");t&&n.hub.server.getQueueMessage(t)},getQueueMessageCallback:function(t){var r,i,u,f;t&&(i=JSON.dateStringToDate(t.Submitted),i&&(r=i.formatDate("MMM dd, HH:mm")),u={id:t.Id,date:r,status:t.Status,message:t.Message,xml:t.Xml},f=n.viewModel,ko.mapping.fromJS(u,f.queueItem),$("#ItemDetail").show().centerInClient())},getQueueNames:function(){n.hub.server.getQueueNames()},getQueueNamesCallback:function(t){var r=[],i,u;for(r.push({text:"All Queues",value:""}),i=0;i<t.length;i++)u={text:t[i],value:t[i]},r.push(u);n.viewModel.queueNames(r);n.viewModel.activeQueue(n.initialQueue)},getWaitingQueueMessageCount:function(){n.hub.server.getWaitingQueueMessageCount(n.viewModel.activeQueue())},getWaitingQueueMessageCountCallback:function(t){n.viewModel.waitingMessages(t)},btnUpdateStatus:function(){var t=ko.mapping.toJS(n.viewModel.status);n.hub?n.hub.server.updateServiceStatus(t).fail(toastr.error):toastr.error("Server is not available. Update failed.")},btnRefresh:function(){window.location.href=page.baseUrl+"?queueName="+n.viewModel.activeQueue()}}),n};